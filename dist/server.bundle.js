(()=>{var e={8:(e,t,o)=>{"use strict";o.r(t),o.d(t,{default:()=>d});var s=o(733),r=o.n(s),n=o(226);const a=o(753);const c=new class{async getCaptcha(e){const t=e.query,o=a.create({size:4,ignoreChars:"0oO1ilLI",color:!0,noise:Math.floor(5*Math.random()),width:150,height:38});void 0!==t.sid?(await(0,n.KY)(t.sid,o.text,600),e.body={code:0,data:o.data}):e.body={code:500,msg:"参数不全！"}}},i=new(r());i.prefix("/public"),i.get("/getCaptcha",c.getCaptcha);const d=i},29:e=>{"use strict";e.exports=require("koa-jwt")},79:(e,t,o)=>{"use strict";o.d(t,{A:()=>i});const s=require("mongoose");var r=o.n(s),n=o(852);r().connect(n.default.DB_URL,{useNewUrlParser:!0}),r().connection.on("connected",()=>{console.log(`MongoDB: ${n.default.DB_NAME}, DB_HOST: ${n.default.MONGO_HOSTNAME} connection opened! `)}),r().connection.on("error",e=>{console.log("Mongoose connection error: "+e)}),r().connection.on("disconnected",()=>{console.log("Mongoose connection disconnected")});const a=r(),c=new a.Schema({username:{type:String},name:{type:String},password:{type:String}}),i=a.model("users",c)},101:e=>{"use strict";e.exports=require("koa")},146:e=>{"use strict";e.exports=require("koa-combine-routers")},181:e=>{"use strict";e.exports=require("buffer")},216:e=>{"use strict";e.exports=require("koa-body")},226:(e,t,o)=>{"use strict";o.d(t,{_W:()=>d,KY:()=>i});const s=require("redis");var r=o(852);const n={socket:{host:r.default.REDIS.host,port:r.default.REDIS.port},password:r.default.REDIS.password,no_ready_check:!0,detect_buffers:!0};let a=(0,s.createClient)(n);const c=async()=>(a.isOpen||await a.connect(),a);a.on("error",e=>{console.error("❌ Redis Client Error:",e.message),setTimeout(async()=>{await c()},2e3)}),a.on("connect",()=>{console.log("✅ Redis connected successfully")}),a.on("end",()=>{console.log("redis connection has closed")}),a.on("reconnecting",e=>{console.log("redis client reconnecting",e.attempt,e.delay)});const i=async(e,t,o)=>{await c(),void 0!==t&&null!=t&&""!==t&&("object"==typeof t?await a.hSet(e,t):o?await a.setEx(e,o,t):await a.set(e,t))},d=async e=>(await c(),a.get(e))},291:(e,t,o)=>{const s=o(572),r=o(852),n=o(340);e.exports=async function(e,t){const o=s.createTransport({host:"smtp.qq.com",port:587,secure:!1,auth:{user:"285273676@qq.com",pass:"pkblqdtiadnsbhdf"}}),a=`${r.baseUrl}/#${"email"===e.type?"/confirm":"/reset"}?`+n.stringify(e.data),c={from:'"认证邮件" <285273676@qq.com>',to:e.email,subject:""!==e.user&&"email"!==e.type?`你好开发者，${e.user}！《慕课网前端全栈实践》${"reset"===e.type?"重置密码链接！":"注册码！"}`:"《慕课网前端全栈实践》确认修改邮件链接",text:`您在《慕课网前端全栈实践》课程中注册，您的邀请码是${e.code},邀请码的过期时间: ${e.expire}`,html:`\n        <div style="border: 1px solid #dcdcdc;color: #676767;width: 600px; margin: 0 auto; padding-bottom: 50px;position: relative;">\n        <div style="height: 60px; background: #393d49; line-height: 60px; color: #58a36f; font-size: 18px;padding-left: 10px;">Imooc社区——欢迎来到官方社区</div>\n        <div style="padding: 25px">\n          <div>您好，${e.user}童鞋，重置链接有效时间30分钟，请在${e.expire}之前${e.code?"重置您的密码":"修改您的邮箱为："+e.data.username}：</div>\n          <a href="${a}" style="padding: 10px 20px; color: #fff; background: #009e94; display: inline-block;margin: 15px 0;">${e.code?"立即重置密码":"确认设置邮箱"}</a>\n          <div style="padding: 5px; background: #f2f2f2;">如果该邮件不是由你本人操作，请勿进行激活！否则你的邮箱将会被他人绑定。</div>\n        </div>\n        <div style="background: #fafafa; color: #b4b4b4;text-align: center; line-height: 45px; height: 45px; position: absolute; left: 0; bottom: 0;width: 100%;">系统邮件，请勿直接回复</div>\n    </div>\n    `};return t&&((e,t)=>{e.subject="你好，你的验证码",e.text=`您正在绑定您的邮箱，验证码为：${t.code}，验证码过期时间：${t.expire}。`,e.html=""})(c,e),`Message sent: %s, ${(await o.sendMail(c)).messageId}`}},316:e=>{"use strict";e.exports=require("koa-compose")},323:(e,t,o)=>{"use strict";o.r(t),o.d(t,{default:()=>w});var s=o(733),r=o.n(s),n=o(291),a=o.n(n);const c=require("bcrypt");var i=o.n(c);const d=require("dayjs");var u=o.n(d),l=(o(852),o(226));const p=require("jsonwebtoken");var m=o.n(p);require("fs");o(928);const g=async(e,t)=>{const o=await(0,l._W)(e);return null!=o&&o.toLowerCase()===t.toLowerCase()};var f=o(976),b=o.n(f),y=o(79);const h=new class{async forget(e){const{body:t}=e.request;try{const o=await a()({code:123456,expire:u()().add(30,"minutes").format("YYYY-MM-DD HH:mm:ss"),email:t.username,user:"小皮球"});e.body={code:0,data:o,msg:"邮件发送成功"}}catch(e){console.log(e)}}async login(e){const{body:t}=e.request,o=t.sid,s=t.code;if(await g(o,s)){let o=!1;const s=await y.A.findOne({username:t.username});if(null===s)return void(e.body={code:500,msg:"用户名或者密码错误"});if(await i().compare(t.password,s.password)&&(o=!0),o){const t=m().sign({username:"admin"},b()(process.env.JWT_SECRET),{expiresIn:86400});e.body={code:0,data:{token:t},msg:"登录成功"}}else e.body={code:500,msg:"用户名或者密码错误"}}else e.body={code:401,msg:"图片验证码不正确,请检查！"}}async reg(e){const{body:t}=e.request,o=t.sid,s=t.code;let r={};let n=!0;if(await g(o,s)){const o=await y.A.findOne({username:t.username});null!==o&&void 0!==o.username&&(r.username="此邮箱已经注册，可以通过邮箱找回密码",n=!1);const s=await y.A.findOne({name:t.name});if(null!==s&&void 0!==s.name&&(r.name="此昵称已经被注册，请修改",n=!1),n){t.password=await i().hash(t.password,5);const o=new y.A({username:t.username,name:t.name,password:t.password,created:u()().format("YYYY-MM-DD HH:mm:ss")}),s=await o.save();return void(e.body={code:0,data:s,msg:"注册成功"})}}else r.code="验证码已经失效，请重新获取！";e.body={code:500,msg:r}}},v=new(r());v.prefix("/login"),v.post("/forget",h.forget),v.post("/login",h.login),v.post("/reg",h.reg);const w=v},340:e=>{"use strict";e.exports=require("qs")},388:e=>{"use strict";e.exports=require("koa-compress")},499:(e,t,o)=>{var s={"./loginRouter.js":323,"./publicRouter.js":8,"routes/modules/loginRouter.js":323,"routes/modules/publicRouter.js":8};function r(e){var t=n(e);return o(t)}function n(e){if(!o.o(s,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return s[e]}r.keys=function(){return Object.keys(s)},r.resolve=n,e.exports=r,r.id=499},546:e=>{"use strict";e.exports=require("koa-json")},572:e=>{"use strict";e.exports=require("nodemailer")},694:e=>{"use strict";e.exports=require("koa-static")},695:e=>{"use strict";e.exports=require("@koa/cors")},721:e=>{"use strict";e.exports=require("koa-helmet")},733:e=>{"use strict";e.exports=require("koa-router")},753:e=>{"use strict";e.exports=require("svg-captcha")},774:e=>{"use strict";e.exports=require("stream/web")},852:(e,t,o)=>{"use strict";o.r(t),o.d(t,{default:()=>i});o(928);const s=process.env.DB_USER||"koa",r=process.env.DB_PASS||"925926",n=process.env.DB_HOST||"47.95.36.160",a=process.env.DB_PORT||"27018",c=process.env.DB_NAME||"koa",i={DB_NAME:c,MONGO_HOSTNAME:n,DB_URL:`mongodb://${s}:${r}@${n}:${a}/${c}`,REDIS:{host:process.env.REDIS_HOST||"47.95.36.160",port:process.env.REDIS_PORT||6379,password:process.env.REDIS_PASS||"925926"},JWT_SECRET:"zzf",baseUrl:"http://front.dev.toimc.com:22500",uploadPath:"/app/public",adminEmail:["admin-email@qq.com"],publicPath:[/^\/public/,/^\/login/,/^\/content/,/^\/user/,/^\/comments/],isDevMode:!1,port:3e3,wsPort:3001,AppID:"wxc47d78881f2e620c",AppSecret:"your-app-secret",SubIds:["e1vWHQiTOW9_cP6l31RtO_SDc41hOfhcqhWFCb0cquk","3icSr0YIBLcMSYXchHBTWgCiAAom4lrkJqZAf2pVc-4","6q9Rrn0uekifZbdMuhfzmvexEnZh0Qcv2gfHUBsi1kk","xVA_zdzgM8zPtpDOO92rpK9kQumz4O84E7sTy9Ihfds","sG80CJj2GvArifGRCWOJhumIyY5mQnM94RWGQkdctGc"]}},928:e=>{"use strict";e.exports=require("path")},968:(e,t,o)=>{const s=o(146),r=o(499),n=r.keys().reduce((e,t)=>{const o=r(t);return e.push(o.default),e},[]);e.exports=s(n)},976:e=>{"use strict";e.exports=require("md5")}},t={};function o(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={exports:{}};return e[s](n,n.exports,o),n.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var s in t)o.o(t,s)&&!o.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";o(852);var e=o(976),t=o.n(e);const s=require("dotenv");var r=o.n(s);o(79),o(226);o.g.ReadableStream=o(774).ReadableStream,o.g.WritableStream=o(774).WritableStream,o.g.TransformStream=o(774).TransformStream,o.g.Blob=o(181).Blob,o.g.File=o(181).File;const n=o(101),a=o(29),c=new n,i=o(928),d=(o(733),o(968)),u=o(695),{koaBody:l}=o(216),p=o(546),m=o(721),g=o(694),f=o(316),b=o(388);r().config();const y=a({secret:t()(process.env.JWT_SECRET)}).unless({path:[/^\/public/,/^\/login/]}),h=f([l(),u(),p({pretty:!1,param:"pretty"}),m(),g(i.join("src","../public")),async(e,t)=>t().catch(t=>{401==t.status?(e.status=401,console.log("我到了这里了"),e.body={code:401,message:"Protected resource, use Authorization header to get access\n"}):(e.status=t.status||500,e.body=Object.assign({code:t.code||500,msg:t.message},{}))}),y]);c.use(b()),c.use(h),c.use(d()),c.listen(3002)})()})();